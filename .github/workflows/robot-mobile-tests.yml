name: Robot Mobile Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  mobile-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_API_LEVEL: 30
      ANDROID_TARGET: google_apis
      ANDROID_ABI: x86_64
      AVD_NAME: githubEmulator
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install "robotframework>=7,<8" "robotframework-appiumlibrary>=3.1,<4.0" "robotframework-seleniumlibrary>=6,<7" pyyaml

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Appium globally
        run: |
          npm install -g appium @appium/doctor
          appium driver install uiautomator2
          appium --version
          appium driver list --installed

      - name: Install Android components
        run: |
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdline-tools.zip
          rm -rf $ANDROID_HOME/cmdline-tools
          mkdir -p $ANDROID_HOME/cmdline-tools
          unzip -q cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
          mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          rm cmdline-tools.zip
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-$ANDROID_API_LEVEL" \
            "emulator" \
            "system-images;android-$ANDROID_API_LEVEL;$ANDROID_TARGET;$ANDROID_ABI"

      - name: Create AVD
        run: |
          echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd \
            -n $AVD_NAME \
            -k "system-images;android-$ANDROID_API_LEVEL;$ANDROID_TARGET;$ANDROID_ABI" \
            --force --device "pixel"
          $ANDROID_HOME/emulator/emulator -list-avds

      - name: Start emulator
        run: |
          echo "Iniciando emulador em background..."
          nohup $ANDROID_HOME/emulator/emulator -avd $AVD_NAME -no-snapshot -no-window -gpu swiftshader_indirect -no-audio -no-boot-anim > emulator.log 2>&1 &
          echo $! > emulator.pid
          
          echo "Reiniciando adb server..."
          $ANDROID_HOME/platform-tools/adb kill-server || true
          $ANDROID_HOME/platform-tools/adb start-server
          
          echo "Aguardando device (timeout 5min)..."
          timeout 300 $ANDROID_HOME/platform-tools/adb wait-for-device || {
            echo "ERRO: Device não apareceu em 5min"
            echo "=== Últimas 100 linhas do emulator.log ==="
            tail -n 100 emulator.log
            echo "=== adb devices ==="
            $ANDROID_HOME/platform-tools/adb devices
            exit 1
          }
          
          echo "Device detectado, aguardando boot completo..."
          $ANDROID_HOME/platform-tools/adb devices
          
          for i in {1..30}; do
            BOOT=$($ANDROID_HOME/platform-tools/adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$BOOT" = "1" ]; then
              echo "Boot completo na iteração $i"
              break
            fi
            echo "Aguardando boot ($i/30)..."
            sleep 10
          done
          
          if [ "$BOOT" != "1" ]; then
            echo "ERRO: Boot não completou em 5min"
            echo "=== Últimas 150 linhas do emulator.log ==="
            tail -n 150 emulator.log
            echo "=== adb devices ==="
            $ANDROID_HOME/platform-tools/adb devices
            exit 1
          fi
          
          echo "Configurando device..."
          $ANDROID_HOME/platform-tools/adb shell input keyevent 82 || true
          $ANDROID_HOME/platform-tools/adb shell settings put global window_animation_scale 0 || true
          $ANDROID_HOME/platform-tools/adb shell settings put global transition_animation_scale 0 || true
          $ANDROID_HOME/platform-tools/adb shell settings put global animator_duration_scale 0 || true
          $ANDROID_HOME/platform-tools/adb shell cmd package install-existing com.android.chrome || true
          echo "Emulador pronto!"

      - name: Run Robot tests
        run: |
          nohup appium --allow-insecure chromedriver_autodownload --relaxed-security --log-level info > appium.log 2>&1 &
          sleep 10
          mkdir -p results
          DEVICE=$($ANDROID_HOME/platform-tools/adb devices | awk 'NR==2 {print $1}')
          echo "Using device: $DEVICE"
          robot -v DEVICE_NAME:$DEVICE -d results tests/mobile_open_youtube.robot

      - name: Upload Robot Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-results
          path: results

      - name: Upload Appium Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log
          path: appium.log

      - name: Upload Emulator Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: emulator-log
          path: emulator.log

      - name: Stop emulator
        if: always()
        run: |
          if [ -f emulator.pid ]; then
            $ANDROID_HOME/platform-tools/adb -s emulator-5554 emu kill || true
            kill $(cat emulator.pid) || true
            rm emulator.pid
          fi
